{% extends 'matistikk/base.html' %}
{% load staticfiles %}
{% load static %}
{% load customtags %}
{% block head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/i18n/jquery-ui-i18n.min.js"></script>

    <script type="text/javascript" src="{% static 'maths/js/bootstrap-clockpicker.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'maths/css/bootstrap-clockpicker.min.css' %}" type="text/css"/>
    <script type="text/javascript" src="{% static 'tinymce/js/tinymce/tinymce.min.js' %}"></script>
    <script type="text/javascript"
            src="{% static 'tinymce/js/tinymce/plugins/equationeditor/mathquill.min.js' %}"></script>
    <script>
        var configurl = '{% static 'tinymce/js/tinymce/plugins/equationeditor/config.json' %}';
        tinymce.PluginManager.load('equationeditor', "{% static 'tinymce/js/tinymce/plugins/equationeditor/plugin.min.js'%}");

        tinymce.init({
            selector: '#previewtasktext',
            plugins: 'placeholder',
            content_css: '{% static 'tinymce/js/tinymce/plugins/equationeditor/mathquill.css'%}',
            toolbar: false,
            menubar: false,
            statusbar: false,
            readonly: 1,
            body_id: 'tasktextID'
        });
        tinymce.init({
            selector: '#previewtextanswer',
            plugins: 'placeholder',
            content_css: '{% static 'tinymce/js/tinymce/plugins/equationeditor/mathquill.css'%}',
            toolbar: false,
            menubar: false,
            statusbar: false,
            readonly: 1

        });

        tinymce.init({
            selector: '#previewreasoning',
            plugins: 'placeholder',
            content_css: '{% static 'tinymce/js/tinymce/plugins/equationeditor/mathquill.css'%}',
            toolbar: false,
            menubar: false,
            statusbar: false,
            readonly: 1
        });


    </script>

{% endblock %}
{% block body %}
    <div class="panel panel-info">
        <div class="panel-heading">
            <h2>{{ test.task_collection.test_name }} - {{ test.id }}</h2>
            <div class="row">
                <div class="col-md-2">
                    <h5><strong><i class="fa fa-calendar" aria-hidden="true"></i>
                        Publisert:</strong> {{ test.published }}</h5>
                    <h5><strong><i class="fa fa-random" aria-hidden="true"></i> Tilfeldig rekkefølge:</strong>
                        {% if test.randomOrder %}Ja{% else %}Nei{% endif %}</h5>
                </div>
                <div class="col-md-2">
                    <h5 id="id_dueDate"><strong><i class="fa fa-calendar" aria-hidden="true"></i>
                        Frist for besvarelse:</strong>
                        {% if test.dueDate %}{{ test.dueDate }}{% else %}Ingen{% endif %}
                    </h5>
                    {% if fromGrade %}
                        <h5><strong><i class="fa fa-graduation-cap" aria-hidden="true"></i>Klasse:
                        </strong>{{ fromGrade }}</h5>
                    {% endif %}
                </div>
            </div>

        </div>
        <div class="panel-body">
            <ul class="nav nav-tabs">
                {% if students %}
                    <li id="studentTab" class="nav active"><a href="#A" data-toggle="tab">Elever</a></li>{% endif %}
                {% if teachers %}
                    <li id="teacherTab" class="nav"><a href="#B" data-toggle="tab">Lærere</a></li>{% endif %}
                {% if grades %}
                    <li id="gradeTab" class="nav"><a href="#C" data-toggle="tab">Klasser</a></li>{% endif %}
                {% if groups %}
                    <li id="groupTab" class="nav"><a href="#D" data-toggle="tab">Grupper</a></li>{% endif %}
                <li class="nav"><a href="#E" data-toggle="tab">Oppgaver</a></li>
            </ul>
            <div class="tab-content">
                {% if students %}
                    <div class="tab-pane fade in active" id="A">
                        <table class="table table-hover table-striped table-responsive" id="studenttable">
                            <thead>
                            <tr>
                                <th>Fornavn</th>
                                <th>Etternavn</th>
                                <th>Brukernavn</th>
                                <th>Levert</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for student in students %}
                                <tr id="user{{ student.id }}">
                                    <td>{{ student.first_name }}</td>
                                    <td>{{ student.last_name }}</td>
                                    <td>{{ student.username }}</td>
                                    <td>{% answered student test as answer %}{% if answer %}
                                        {{ answer.date_answered }}{% else %}-{% endif %}
                                    </td>
                                    <td>
                                        <button type="button" disabled='disabled' id="{{ student.username }}"
                                                class='btn btn-default button goToAnswer'>
                                            <i class="fa fa-check-circle" aria-hidden="true"></i>
                                            Besvarelse
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                {% if teachers %}
                    <div class="tab-pane fade" id="B">
                        <table class="table table-hover table-striped table-responsive" id="teachertable">
                            <thead>
                            <tr>
                                <th>Fornavn</th>
                                <th>Etternavn</th>
                                <th>Brukernavn</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for teacher in teachers %}
                                <tr id="user{{ teacher.id }}">
                                    <td>{{ teacher.first_name }}</td>
                                    <td>{{ teacher.last_name }}</td>
                                    <td>{{ teacher.username }}</td>
                                    <td>
                                        <button disabled='disabled' id="{{ teacher.username }}"
                                                value="{{ teacher.username }}"
                                                class='btn btn-default goToAnswer'>
                                            <i class="fa fa-check-circle" aria-hidden="true"></i>
                                            Besvarelse
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                {% if grades %}

                    <div class="tab-pane fade" id="C">
                        <div id="menu" style="padding-top: 10px">
                            <div class="panel list-group">
                                {% for grade in grades %}
                                    <a class="list-group-item" data-toggle="collapse" style="cursor: pointer"
                                       data-target="#grade{{ grade.id }}"
                                       data-parent="#menu">{{ grade }} <span
                                            class="label label-info">6</span>
                                        <span class="label label-success">3</span>
                                        <span class="label label-danger">3</span>
                                        <span class="glyphicon glyphicon-education pull-right"></span></a>
                                    <div id="grade{{ grade.id }}" class="sublinks collapse">
                                        {% for student in grade.person_set.all %}
                                            {% if student.role == 1 %}
                                                {% answered student test as answer %}
                                                <a class="list-group-item small" data-username="{{ student.username }}"
                                                   {% if answer %}data-answer="{{ answer.id }}"
                                                   {% else %}data-answer=""{% endif %}
                                                   style="padding-left: 50px; cursor: pointer;"><span
                                                        class="glyphicon glyphicon-user"></span>
                                                    {{ student }}
                                                    {% if answer %}
                                                        <p class="pull-right">Besvart: {{ answer.date_answered }}</p>
                                                    {% else %}
                                                        <p class="pull-right">Ikke besvart</p>
                                                    {% endif %}
                                                </a>

                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if groups %}
                    <div class="tab-pane fade" id="D">
                        <div id="menu" style="padding-top: 10px">
                            <div class="panel list-group">
                                {% for group in groups %}
                                    <a class="list-group-item" data-toggle="collapse" style="cursor: pointer"
                                       data-target="#group{{ group.id }}"
                                       data-parent="#menu">{{ group }} <span
                                            class="label label-info"></span>
                                        <span class="label label-success"></span>
                                        <span class="label label-danger"></span>
                                        <i class="fa fa-users pull-right" aria-hidden="true"></i></a>
                                    <div id="group{{ group.id }}" class="sublinks collapse">
                                        {% for student in group.persons.all %}
                                            {% if student.role == 1 %}
                                                {% answered student test as answer %}
                                                <a class="list-group-item small" data-username="{{ student.username }}"
                                                   {% if answer %}data-answer="{{ answer.id }}"
                                                   {% else %}data-answer=""{% endif %}
                                                   style="padding-left: 50px; cursor: pointer;"><span
                                                        class="glyphicon glyphicon-user"></span>
                                                    {{ student }}
                                                    {% if answer %}
                                                        <p class="pull-right">Besvart: {{ answer.date_answered }}</p>
                                                    {% else %}
                                                        <p class="pull-right">Ikke besvart</p>
                                                    {% endif %}
                                                </a>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                <div class="tab-pane fade" id="E">
                    <table class="table table-hover table-striped table-responsive" id="tasktable">
                        <thead>
                        <tr>
                            <th class="col-md-1">ID</th>
                            <th>Oppgavenavn</th>
                            <th>Kategori</th>
                            <th>Laget av</th>
                            <th>Alternativer</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% if test.randomOrder %}
                            {% for task in test.task_collection.tasks.all %}
                                <tr class="clickable-row"
                                    data-href="#">
                                    <td>
                                        {{ task.id }}
                                    </td>
                                    <td>
                                        {{ task.title }}
                                    </td>
                                    <td>
                                        {% for category in task.category.all %}
                                            {% if forloop.last %}
                                                {{ category }}
                                            {% else %}
                                                {{ category }} -
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {{ task.author.get_full_name }}
                                    </td>
                                    <td>
                                        <button value="{{ task.id }}" type="button" onclick="previewTask(this)"
                                                class="btn btn-default btn-sm"><span
                                                class="glyphicon glyphicon-eye-open"></span> Forhåndsvis
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            {% for task in test.taskorder_set.all %}
                                <tr class="clickable-row"
                                    data-href="#">
                                    <td>
                                        {{ task.task.id }}
                                    </td>
                                    <td>
                                        {{ task.task.title }}
                                    </td>
                                    <td>
                                        {% for category in task.task.category.all %}
                                            {% if forloop.last %}
                                                {{ category }}
                                            {% else %}
                                                {{ category }} -
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {{ task.task.author.get_full_name }}
                                    </td>
                                    <td>
                                        <button value="{{ task.task.id }}" type="button" onclick="previewTask(this)"
                                                class="btn btn-default btn-sm"><span
                                                class="glyphicon glyphicon-eye-open"></span> Forhåndsvis
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        {% if request.user.role == 4 %}
            <div class="panel-footer">
                <button id="addPublish" class="btn btn-primary" type="button" data-toggle="tooltip"
                        onclick="publishModal()"
                        title="Tidsfristen for denne oppgaven er utgått" disabled="disabled"><span
                        class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    Publiser
                </button>
                <button class="btn btn-primary" data-toggle="modal" data-target="#updateDueDateModal"><i
                        class="fa fa-clock-o" aria-hidden="true"></i>
                    Oppdater tidsfrist
                </button>
                <button class="btn btn-primary" onclick="download()"><i class="fa fa-download" aria-hidden="true"></i>
                    Eksporter svarresultater
                </button>
            </div> <!-- #Panel-footer -->
        {% endif %}
    </div>
    <form action="" method="post">{% csrf_token %}</form>


    <script>


        $(document).ready(function () {
            var date = "{{ test.dueDate }}";
            var dueDate = new Date(date);
            var now = new Date();
            if (date == 'None') {
                $('#addPublish').attr('disabled', false);
                $('#addPublish').attr('title', 'Legg til ');
            } else if (dueDate > now) {
                $('#addPublish').attr('disabled', false);
                $('#addPublish').attr('title', 'Legg til ');
            }
            if ($("#studentTab").length == 0) {
                $('#teacherTab').addClass('active');
                $('#B').removeClass('fade');
                $('#B').addClass('active');
                if ($('#teacherTab').length == 0) {
                    $('#gradeTab').addClass('active');
                    $('#C').removeClass('fade');
                    $('#C').addClass('active');
                    if ($('#gradeTab').length == 0) {
                        $('#groupTab').addClass('active');
                        $('#D').removeClass('fade');
                        $('#D').addClass('active');
                    }
                }
            }
            var students = $('#studenttable tr').not(':first');
            students.each(function () {
                var button = $(this).find(':button');
                var answered = $(this).find('td').eq(3);
                if (answered.text().trim() != "-") {
                    $(this).addClass('success');
                    button.removeAttr('disabled');
                }
            });
            var group = $('.list-group-item').not(".small");
            group.each(function (index) {
                var success = 0;
                var danger = 0;
                var id = $(this).data("target");
                var items = $(id).find('.list-group-item');
                items.each(function () {
                    if ($(this).data('answer') != "") {
                        $(this).addClass('list-group-item-success');
                        success += 1;
                    } else {
                        danger += 1;
                    }
                });
                $(this).find('.label-info').text(items.length);
                $(this).find('.label-success').text(success);
                $(this).find('.label-danger').text(danger);
            });
        });

        $(function () {
            $("#datepickerUpdateDue").datepicker($.datepicker.regional["no"]);
            $("#datepickerUpdateDue").datepicker("option", "showButtonPanel", true);
            $("#datepickerUpdateDue").datepicker("option", "dateFormat", "DD, d MM, yy");
            $("#datepickerUpdateDue").datepicker("option", "minDate", "0");
        });
        $("td > a").attr("disabled", "disabled").on("click", function () {
            return false;
        });

        $('.goToAnswer').click(function () {
            var username = this.id;
            var testID = "{{ test.id }}";
            var url = "{% url 'maths:answerDetail' test_pk=1234 slug=5678 %}".replace(/1234/, testID).replace(/5678/, username);
            document.location.href = url;
        });

        $('.list-group-item').not(".small").on('click', function () {
            var $this = $(this);
            if ($this.hasClass('active')) {
                $('.list-group .active').removeClass('active');
            } else {
                $('.list-group .active').removeClass('active');
                $this.addClass('active');
            }
        });
        $('.list-group-item.small').on('click', function () {
            var $this = $(this);
            var name = $this.text();
            var fullName = name.split("-");
            $this.addClass('active');
            if ($this.hasClass('list-group-item-success')) {
                var username = $(this).data('username');
                bootbox.confirm({
                    size: "medium",
                    title: "Besvarelse - {{ test.task_collection.test_name }}",
                    message: "Gå til " + fullName[0] + "sin besvarelsen av {{ test.task_collection.test_name }}?",
                    backdrop: true,
                    buttons: {
                        cancel: {
                            label: '<i class="fa fa-times"></i> Avbryt'
                        },
                        confirm: {
                            label: '<i class="fa fa-check"></i> Gå til besvarelse',
                            className: 'btn-success'
                        }
                    },
                    callback: function (result) {
                        if (result == false) {
                            $this.removeClass('active');
                        } else {
                            var testID = "{{ test.id }}";
                            var url = "{% url 'maths:answerDetail' test_pk=1234 slug=5678 %}".replace(/1234/, testID).replace(/5678/, username);
                            document.location.href = url;
                        }
                    }
                });
            } else {
                bootbox.alert({
                    title: "Advarsel!",
                    message: "Denne brukeren har ikke levert inn noen besvarelse enda!",
                    backdrop: true,
                    callback: function () {
                        $this.removeClass('active');
                    }
                })
            }
        });
        function publishModal() {
            $('#publishModal').modal('show');
        }

        function download() {
            var testID = "{{ test.id }}";
            var exportURL = "{% url 'maths:answerExport' test_pk=1234 %}".replace(/1234/, testID);
            document.location.href = exportURL;
        }

        function publish() {
            var username = "{{ request.user.username }}";
            var testID = "{{ test.id }}";
            var students = [];
            var grades = [];
            var groups = [];
            var studentTable = $('#studenttablemodal tr.success');
            var teacherTable = $('#teachertablemodal tr.success');
            var gradeTable = $('#gradetablemodal tr.success');
            var groupTable = $('#grouptablemodal tr.success');
            studentTable.each(function () {
                var id = $(this).find(':checkbox').val();
                students.push(id);
            });
            teacherTable.each(function () {
                var id = $(this).find(':checkbox').val();
                students.push(id);
            });
            gradeTable.each(function () {
                var id = $(this).find(':checkbox').val();
                grades.push(id);
            });
            groupTable.each(function () {
                var id = $(this).find(':checkbox').val();
                groups.push(id);
            });
            var students_id = JSON.stringify(students);
            var grades_id = JSON.stringify(grades);
            var groups_id = JSON.stringify(groups);
            $.ajax({
                type: 'POST',
                url: '{% url 'maths:testList' slug=12345 %}'.replace(/12345/, username),
                data: {
                    'test': testID,
                    'grades': grades_id,
                    'groups': groups_id,
                    'students': students_id,
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                },
                dataType: 'json',
                success: function () {
                    $('.alert-success').removeClass('hidden');
                    $(".alert-success").fadeTo(5500, 500).slideUp(500, function () {
                        location.reload();
                    });
                },
                error: function (xhr) {
                    alert('error');
                    alert(xhr.responseText);
                }
            });

        }

        function updateDueDate() {
            var newDueDate = new Date($("#datepickerUpdateDue").datepicker("getDate"));
            var strNewDueDate = newDueDate.getFullYear() + "-" + (newDueDate.getMonth() + 1) + "-" + newDueDate.getDate();
            var newDueTime = $('#timepickerUpdateDue').val();
            var newDueDateAndTime = strNewDueDate + " " + newDueTime;
            $.ajax({
                type: 'POST',
                url: '{% url 'maths:testCreate'  taskCollection_pk=12345%}'.replace(/12345/, {{ test.task_collection.id }}),
                data: {
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    'id': {{ test.id }},
                    'dueDate': newDueDateAndTime
                },
                dataType: 'json',
                success: function (json) {
                    var date = $('#datepickerUpdateDue').val();
                    $('#id_dueDate').html('<strong>Frist for besvarelse: </strong>' + date + " " + newDueTime);
                    $('#newDate').text('Frist for besvarelse ble oppdatert til ' + date + " " + newDueTime);
                    $('#successDueDate').removeClass('hidden');
                    setTimeout(function () {
                        $('#updateDueDateModal').modal('hide');
                        $('#successDueDate').addClass('hidden');
                    }, 2000);
                },
                error: function (xhr) {
                    alert('error');
                    alert(xhr.responseText);
                }
            });
        }

        /**
         * This function sets up the taskinformation gotten inside a modal from the ajax GET request.
         */
        function previewTask(e) {
            var id = e.value;
            $('#geogebradiv').hide();
            $('#textanswerdiv').hide();
            $('#reasoningdiv').hide();
            $('#multiplechoicediv').hide();
            $.ajax({
                type: 'GET',
                url: '{% url 'maths:taskList' %}',
                data: {
                    'task_id': id
                },
                dataType: 'json',
                success: function (json) {

                    var task = (json);
                    if (task.geogebra_preview != undefined) {
                        $("#previewbilde").attr("src", 'data:image/png;base64,' + (task.geogebra_preview));
                        $('#geogebradiv').show();
                    }
                    tinyMCE.get('previewtasktext').setContent(task.task_text);

                    var answertype = (task.task_answertype);
                    if (answertype == 1) {
                        $('#previewtextanswerdiv').show();
                    }

                    if (task.task_reasoning) {
                        $('#reasoningdiv').show();
                    }
                    if (answertype == 2) {
                        var options = (task.options);
                        var div = document.getElementById('optionsdiv');
                        $('#multiplechoicediv').show();
                        div.innerHTML = "";
                        $.each(options, function (index, value) {
                            div.innerHTML += "<input type='radio' name='optionsradio'> " + (value.option) + "<br>";
                        });
                    }
                    $('#previewTaskModal').modal('show');
                },
                error: function (xhr) {
                    alert('error');
                    alert(xhr.responseText);
                }
            });
        }
    </script>
{% endblock %}

{% block modal %}
    <div class="modal fade" id="previewTaskModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" style="width: 95%">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Forhåndsvis oppgave</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6" id="geogebradiv" style="padding-right: 10px;">
                            <img id='previewbilde' alt='' width="100%" style="border:1px solid #021a40;"/>
                        </div>
                        <div class="col-md-6" style="padding-left: 10px">
                            <div class="panel panel-default">
                                <div class="panel-heading" id="previewtasktextdiv">
                                    <textarea id="previewtasktext"></textarea>
                                </div>
                                <div class="panel-body">
                                    <div id="previewtextanswerdiv">
                                        <label for="previewtextanswer">Tekstsvar</label>
                                        <textarea class="form-control" id="previewtextanswer" rows="6"
                                                  style="resize:vertical"
                                                  placeholder="Skriv svaret ditt her..."></textarea>
                                    </div>

                                    <div id="multiplechoicediv">
                                        <label for="reasoning">Svaralternativer</label>
                                        <div id="optionsdiv">

                                        </div>
                                    </div>

                                    <div id="previewreasoningdiv">
                                        <label for="previewreasoningreasoning">Begrunnelse</label>
                                        <textarea class="form-control" id="previewreasoning" rows="6"
                                                  style="resize:vertical"
                                                  placeholder="Begrunn svaret ditt..."></textarea>
                                    </div>

                                </div>
                                <div class="panel-footer">
                                    <button type="button" class="btn btn-success">Svar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Lukk</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="updateDueDateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Oppdater tidsfrist</h4>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input id="datepickerUpdateDue" type="text" class="form-control"
                               placeholder="Velg ny dato for leveringsfrist"
                               aria-describedby="basic-addon1"
                               style="position: relative; z-index: 9999;">
                        <span class="input-group-addon" id="basic-addon1"><i
                                class="fa fa-calendar" aria-hidden="true"></i></span>
                    </div>
                    <div class="input-group clockpicker" style="margin-top: 10px;">
                        <input id="timepickerUpdateDue" class="form-control"
                               placeholder="Velg nytt klokkeslett for leveringsfrist"
                               aria-describedby="basic-addon1" style="position: relative; z-index: 9999 !important;">
                        <span class="input-group-addon" id="basic-addon1"><i
                                class="fa fa-clock-o" aria-hidden="true"></i></span>
                    </div>
                    <div id="successDueDate" class="alert alert-success hidden" style="margin-top: 10px">
                        <strong>Fullført!</strong> <h5 id="newDate"></h5>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="updateDueDate()">
                        <i class="fa fa-check-square-o" aria-hidden="true"></i> Oppdater
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Lukk</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="publishModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" style="width: 75%">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h3 class="modal-title text-center">Publiser</h3>
                </div>
                <div class="modal-body">
                    <form action="" method="post">{% csrf_token %}</form>
                    <ul class="nav nav-tabs">
                        <li class="nav active"><a href="#modalA" data-toggle="tab">Elever</a></li>
                        <li class="nav"><a href="#modalB" data-toggle="tab">Lærere</a></li>
                        <li class="nav"><a href="#modalC" data-toggle="tab">Klasser</a></li>
                        <li class="nav"><a href="#modalD" data-toggle="tab">Grupper</a></li>
                        <li class="nav"><a href="#modalE" data-toggle="tab">Skole</a></li>
                        <div class="col-sm-4" style="float: right">
                            <div class="form-group" id="gradeDropDown">
                                <select class="form-control" id="gradeDropList">
                                    <option id="allschools" value="">Velg Klasse</option>
                                    {% for grade in allgrades %}
                                        <option value="{{ grade.id }}">{{ grade }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group" id="schoolDropDown">
                                <select class="form-control" id="schoolDropList">
                                    <option id="allgrades" value="">Velg Skole
                                    </option>
                                    {% for school in allschools %}
                                        <option value="{{ school.id }}">{{ school }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3" style="float: right">
                            <div class="input-group">

                    <span class="input-group-addon">
                        <i class="fa fa-search"></i>
                    </span>
                                <input type="text" class="form-control" id="search"
                                       onkeyup="searchTable('studenttablemodal'); searchTable('teachertablemodal');
                                       searchTable('grouptablemodal'); searchTable('schooltablemodal'); searchGradeTable('gradetablemodal');"
                                       placeholder="Søk etter elever">
                            </div>
                        </div>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="modalA">
                            <table class="table table-hover table-striped table-responsive" id="studenttablemodal">
                                <thead>
                                <tr>
                                    <th class="col-sm-1">Legg til</th>
                                    <th>Fornavn</th>
                                    <th>Etternavn</th>
                                    <th>Brukernavn</th>
                                    <th>Brukerinfo</th>
                                </tr>
                                </thead>
                                <img src="http://dkclasses.com/images/loading.gif"
                                     class="loading-indicator loading-filter"
                                     style="display:none"/>
                                <tbody class="tableclick">
                                {% for student in allstudents %}
                                    <tr id="user{{ student.id }}modal" style="cursor:pointer;">
                                        <td><input type="checkbox"
                                                   value="{{ student.id }}"></td>
                                        <td>{{ student.first_name }}</td>
                                        <td>{{ student.last_name }}</td>
                                        <td>{{ student.username }}</td>
                                        <td><a class="btn btn-default"
                                               href="{% url 'administration:personDetail' student.username %}"><span
                                                class="glyphicon glyphicon-user" aria-hidden="true"></span> Se
                                            Brukerinfo</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="modalB">
                            <table class="table table-hover table-striped table-responsive" id="teachertablemodal">
                                <thead>
                                <tr>
                                    <th class="col-sm-1">Legg til</th>
                                    <th>Fornavn</th>
                                    <th>Etternavn</th>
                                    <th>Brukernavn</th>
                                    <th>Brukerinfo</th>
                                </tr>
                                </thead>
                                <img src="http://dkclasses.com/images/loading.gif"
                                     class="loading-indicator loading-filter"
                                     style="display:none"/>
                                <tbody class="tableclick">
                                {% for teacher in allteachers %}
                                    <tr id="user{{ teacher.id }}modal" style="cursor:pointer;">
                                        <td><input type="checkbox"
                                                   value="{{ teacher.id }}"></td>
                                        <td>{{ teacher.first_name }}</td>
                                        <td>{{ teacher.last_name }}</td>
                                        <td>{{ teacher.username }}</td>
                                        <td><a class="btn btn-default"
                                               href="{% url 'administration:personDetail' teacher.username %}"><span
                                                class="glyphicon glyphicon-user" aria-hidden="true"></span> Se
                                            Brukerinfo</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="modalC">
                            <table class="table table-hover table-striped table-responsive" id="gradetablemodal">
                                <thead>
                                <tr>
                                    <th class="col-sm-2">Legg til</th>
                                    <th>Klasse</th>
                                    <th>Skole</th>
                                    <th>Klasseinfo</th>
                                </tr>
                                </thead>
                                <img src="http://dkclasses.com/images/loading.gif"
                                     class="loading-indicator loading-filter"
                                     style="display:none"/>
                                <tbody class="tableclick">
                                {% for grade in allgrades %}
                                    <tr id="grade{{ grade.id }}modal" style="cursor:pointer;">
                                        <td><input type="checkbox"
                                                   value="{{ grade.id }}"></td>
                                        <td>{{ grade.grade_name }}</td>
                                        <td>{{ grade.school.school_name }}</td>
                                        <td><a class="btn btn-default"
                                               href="{% url 'administration:gradeDetail' school_pk=grade.school_id grade_pk=grade.id %}"><span
                                                class="glyphicon glyphicon-user" aria-hidden="true"></span> Se
                                            Klasseinfo</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="modalD">
                            <table class="table table-hover table-striped table-responsive" id="grouptablemodal">
                                <thead>
                                <tr>
                                    <th class="col-sm-1">Legg til</th>
                                    <th>Gruppenavn</th>
                                    <th>Klasse</th>
                                    <th>Ansvarlig</th>
                                    <th>Gruppeinfo</th>
                                </tr>
                                </thead>
                                <img src="http://dkclasses.com/images/loading.gif"
                                     class="loading-indicator loading-filter"
                                     style="display:none"/>
                                <tbody class="tableclick">
                                {% for group in allgroups %}
                                    <tr id="group{{ group.id }}modal" style="cursor:pointer;">
                                        <td><input type="checkbox"
                                                   value="{{ group.id }}"></td>
                                        <td>{{ group.group_name }}</td>
                                        <td>{% if group.grade %}{{ group.grade }}{% else %}-{% endif %}</td>
                                        <td>{{ group.creator.get_full_name }}</td>
                                        <td><a class="btn btn-default"
                                               href="{% url 'administration:groupDetail' group_pk=group.id %}"><span
                                                class="glyphicon glyphicon-user" aria-hidden="true"></span> Se
                                            Gruppeinfo</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="modalE">
                            <table class="table table-hover table-striped table-responsive" id="schooltablemodal">
                                <thead>
                                <tr>
                                    <th class="col-sm-1">Legg til</th>
                                    <th>Skole</th>
                                    <th>Adresse</th>
                                    <th>Kontaktperson</th>
                                    <th>Skoleinfo</th>
                                </tr>
                                </thead>
                                <img src="http://dkclasses.com/images/loading.gif"
                                     class="loading-indicator loading-filter"
                                     style="display:none"/>
                                <tbody class="tableclick">
                                {% for school in allschools %}
                                    <tr id="school{{ school.id }}modal" style="cursor:pointer;">
                                        <td><input type="checkbox"
                                                   value="{{ school.id }}"></td>
                                        <td>{{ school.school_name }}</td>
                                        <td>{{ school.school_address }}</td>
                                        <td>{{ school.school_administrator.get_full_name }}</td>
                                        <td><a class="btn btn-default"
                                               href="{% url 'administration:schoolDetail' school_pk=school.id %}"><span
                                                class="glyphicon glyphicon-user" aria-hidden="true"></span> Se
                                            Skoleinfo</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="alert alert-success hidden" style="margin-top: 15px; margin-bottom: 0px;">
                        <strong>Fullført!</strong>
                        Testen ble publisert hos de valgte objektene. Nettsiden vil nå lastes inn på nytt.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="publish()">
                        <i class="fa fa-check-square-o" aria-hidden="true"></i> Publiser
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Lukk</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('.clockpicker').clockpicker({
            autoclose: true
        });

        $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
            var search = $('#search');
            var schoolDrop = $('#schoolDropList');
            var gradeDrop = $('#gradeDropList');
            var tab = $(e.target).attr('href');
            if (tab == '#modalA') {
                search.attr("placeholder", "Søk etter elever");
                schoolDrop.attr("disabled", false);
                $('#gradeDropList').attr("disabled", false);
            } else if (tab == '#modalB') {
                search.attr("placeholder", "Søk etter lærere");
                schoolDrop.attr("disabled", false);
                gradeDrop.attr("disabled", false);
            } else if (tab == '#modalC') {
                search.attr("placeholder", "Søk etter klasser");
                gradeDrop.attr("disabled", true);
                schoolDrop.attr("disabled", false);
                gradeDrop.val("").change();
            } else if (tab == '#modalD') {
                search.attr("placeholder", "Søk etter grupper");
                schoolDrop.attr("disabled", true);
                gradeDrop.attr("disabled", false);
                var grade = $("#gradeDropList :selected").val();
                schoolDrop.val("").change();
                gradeDrop.val(grade).change();
            } else if (tab == '#modalE') {
                search.attr("placeholder", "Søk etter skoler");
                schoolDrop.attr("disabled", true);
                gradeDrop.attr("disabled", true);
                gradeDrop.val("").change();
                schoolDrop.val("").change();
            }
        });

        $(".tableclick tr").click(function (e) {
            var $checkbox = $(this).find(':checkbox');
            if (e.target.type == "checkbox") {
                e.stopPropagation();
                if ($checkbox.is(':checked')) {
                    $(this).addClass('success');
                } else {
                    $(this).removeClass('success');
                }
            } else {
                $checkbox.click();
            }
        });

        function searchTable(inputTable) {
            var input, filter, table, tr, td, i, td1, td2;
            input = document.getElementById("search");
            filter = input.value.toUpperCase();
            table = document.getElementById(inputTable);
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[1];
                td1 = tr[i].getElementsByTagName("td")[2];
                td2 = tr[i].getElementsByTagName("td")[3];

                if (td) {
                    if (td.innerHTML.toUpperCase().indexOf(filter) > -1 || td1.innerHTML.toUpperCase().indexOf(filter) > -1
                        || td2.innerHTML.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        function searchGradeTable(inputTable) {
            var input, filter, table, tr, td, i, td1, td2;
            input = document.getElementById("search");
            filter = input.value.toUpperCase();
            table = document.getElementById(inputTable);
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[1];
                td1 = tr[i].getElementsByTagName("td")[2];
                if (td) {
                    if (td.innerHTML.toUpperCase().indexOf(filter) > -1 || td1.innerHTML.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
        $("#schoolDropList").change(function () {
            $("#gradeDropList").val('');
            var school_id = $(this).val();
            var school_name = $("#schoolDropList :selected").text();
            personSchoolFilter(school_id);
            var gradeList = $("#gradeDropList option");
            gradeList.each(function () {
                var grade_id = $(this).val();
                var grade = $(this).text();
                if (school_id == "") {
                    $(this).show();
                }
                else if (grade.indexOf(school_name) >= 0 || grade_id == "") {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        $("#gradeDropList").change(function () {
            var grade_id = $(this).val();
            if (grade_id != "") {
                $('.loading-filter').show();
                $('.tableclick').addClass('hidden');
                $.ajax({
                    type: 'GET',
                    url: '{% url 'administration:personList' %}',
                    data: {
                        'type': 'grade',
                        'grade_id': grade_id
                    },
                    dataType: 'json',
                    success: function (json) {
                        var students = (json.persons);
                        $("#studenttablemodal tbody tr").hide();
                        $("#teachertablemodal tbody tr").hide();
                        $.each(students, function (index, value) {
                            $("#user" + value.id + "modal").show();
                        });
                        $('.loading-filter').hide();
                        $('.tableclick').removeClass('hidden');
                    },
                    error: function (xhr) {
                        alert('error');
                        alert(xhr.responseText);
                    }
                });
                $('#grouptablemodal > tbody  > tr').each(function () {
                    var grade_name = $("#gradeDropList :selected").text();
                    var school = $(this).find("td:eq(2)").html();
                    if (school.indexOf(grade_name) == -1) {
                        $(this).hide();
                    } else {
                        $(this).show();
                    }
                });
            } else {
                var school_id = $("#schoolDropList :selected").val();
                personSchoolFilter(school_id);
            }
        });

        /**
         * Function that gets the userlist with an ajax-call and displays them in the table.
         */
        function personSchoolFilter(school) {
            var school_id = school;
            var school_name = $("#schoolDropList :selected").text();
            if (school_id != "") {
                $('.loading-filter').show();
                $('.tableBody').addClass('hidden');
                $.ajax({
                    type: 'GET',
                    url: '{% url 'administration:personList' %}',
                    data: {
                        'type': 'school',
                        'school_id': school_id
                    },
                    dataType: 'json',
                    success: function (json) {
                        var students = (json.persons);
                        $("#studenttablemodal tbody tr").hide();
                        $("#teachertablemodal tbody tr").hide();
                        $.each(students, function (index, value) {
                            $("#user" + value.id + "modal").show();
                        });
                        $('.loading-filter').hide();
                        $('.tableclick').removeClass('hidden');
                    },
                    error: function (xhr) {
                        alert(xhr.responseText);
                    }
                });
                $('#gradetablemodal > tbody  > tr').each(function () {
                    var school = $(this).find("td:eq(2)").html();
                    if (school.indexOf(school_name) == -1) {
                        $(this).hide();
                    } else {
                        $(this).show();
                    }
                });
            } else {
                $("#studenttablemodal tr").show();
                $("#teachertablemodal tr").show();
                $("#gradetablemodal tr").show();
                $('#grouptablemodal tr').show();
            }
        }

    </script>
{% endblock %}